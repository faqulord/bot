<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SkyShop</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- DESIGN (Fekete & Arany) --- */
        :root { --bg: #000; --card: #111; --gold: #D4AF37; --text: #fff; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; padding-bottom: 90px; margin: 0; user-select: none; }
        .hidden { display: none !important; }
        .container { padding: 15px; }

        /* KÁRTYA STÍLUS */
        .gold-card { 
            background: linear-gradient(135deg, #1a1a1a, #000); 
            border: 1px solid #333; border-left: 4px solid var(--gold); 
            border-radius: 12px; padding: 20px; margin-bottom: 20px;
        }
        .balance-amount { font-size: 32px; font-weight: bold; color: #fff; margin: 5px 0; }
        
        /* BEFIZETÉS DOBOZ */
        .deposit-box { background: #1a1a1a; padding: 15px; border-radius: 10px; border: 1px solid #333; margin-top: 10px;}
        .crypto-address { 
            font-family: monospace; font-size: 11px; color: var(--gold); 
            word-break: break-all; background: #000; padding: 10px; border-radius: 5px; 
            text-align: center; margin-bottom: 10px;
        }
        
        input {
            width: 90%; background: #000; border: 1px solid #444; color: white;
            padding: 12px; border-radius: 8px; margin-bottom: 10px; display: block; margin: 10px auto;
        }
        
        button {
            width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer;
        }
        .btn-gold { background: var(--gold); color: black; }
        .btn-copy { background: #333; color: white; margin-bottom: 10px; }

        /* ALSÓ MENÜ */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; background: #0a0a0a;
            border-top: 1px solid #333; display: flex; justify-content: space-around; padding: 15px 0;
        }
        .nav-item { color: #555; text-align: center; font-size: 10px; flex: 1; }
        .nav-item i { font-size: 20px; margin-bottom: 5px; display: block; }
        .nav-item.active { color: var(--gold); }
        
        .page { display: none; }
        .page.active { display: block; }
    </style>
</head>
<body>

    <div id="page-wallet" class="page active container">
        <div class="gold-card">
            <div style="font-size:12px; color:#888;">EGYENLEG</div>
            <div class="balance-amount"><span id="balance">0</span> Ft</div>
            <div style="font-size:10px; color:#444;" id="userid">ID: Betöltés...</div>
        </div>

        <h3 style="color:var(--gold);">Feltöltés (LTC)</h3>
        <div class="deposit-box">
            <p style="font-size:12px; color:#aaa; text-align:center;">1. Utalj Litecoint erre a címre:</p>
            
            <div class="crypto-address" id="my-address">ltc1qv5aape3pah2f954k5jjx9kgnrnkxzytm6f7an8</div>
            
            <button class="btn-copy" onclick="copyAddr()">Cím Másolása</button>

            <hr style="border-color:#333; margin: 15px 0;">

            <p style="font-size:12px; color:#aaa; text-align:center;">2. Másold be ide a Tranzakció Azonosítót (TXID):</p>
            <input type="text" id="txid-input" placeholder="Illeszd be a TXID-t...">
            
            <button class="btn-gold" onclick="checkPayment()">Ellenőrzés & Jóváírás</button>
        </div>
    </div>

    <div id="page-shop" class="page container">
        <h3 style="color:var(--gold);">Termékek</h3>
        <div class="gold-card" style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <div style="font-weight:bold;">Mystery Box</div>
                <div style="color:var(--gold);">5,000 Ft</div>
            </div>
            <button class="btn-gold" style="width:auto; padding: 5px 15px;" onclick="buyItem(5000)">Vétel</button>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="nav('wallet', this)"><i class="fas fa-wallet"></i>Tárca</div>
        <div class="nav-item" onclick="nav('shop', this)"><i class="fas fa-shopping-cart"></i>Bolt</div>
        <div class="nav-item"><i class="fas fa-user"></i>Profil</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // Felhasználó betöltése
        const user = tg.initDataUnsafe.user;
        if (user) document.getElementById('userid').innerText = "ID: " + user.id;

        // Egyenleg kezelése
        let currentBalance = localStorage.getItem('balance') ? parseInt(localStorage.getItem('balance')) : 0;
        updateDisplay();

        function updateDisplay() {
            document.getElementById('balance').innerText = currentBalance.toLocaleString();
        }

        // Navigáció
        function nav(page, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('page-' + page).classList.add('active');
            btn.classList.add('active');
        }

        function copyAddr() {
            const addr = document.getElementById('my-address').innerText;
            navigator.clipboard.writeText(addr).then(() => tg.showAlert("Cím másolva!"));
        }

        function buyItem(price) {
            if (currentBalance >= price) {
                tg.showConfirm("Megveszed?", (ok) => {
                    if(ok) {
                        currentBalance -= price;
                        localStorage.setItem('balance', currentBalance);
                        updateDisplay();
                        tg.showAlert("Vásárlás sikeres! (A koordinátákat a bot küldi)");
                    }
                });
            } else {
                tg.showAlert("Nincs elég pénzed! Töltsd fel a tárcádat.");
            }
        }

        // --- FIZETÉS ELLENŐRZÉS ---
        async function checkPayment() {
            const txid = document.getElementById('txid-input').value.trim();
            const myAddr = document.getElementById('my-address').innerText;

            if (txid.length < 10) {
                return tg.showAlert("Ez nem tűnik érvényes TXID-nek!");
            }

            tg.MainButton.text = "Ellenőrzés...";
            tg.MainButton.show();

            try {
                const response = await fetch('/api/verify', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ txid: txid, myAddress: myAddr })
                });

                const data = await response.json();
                tg.MainButton.hide();

                if (data.success) {
                    const addedMoney = data.amount_huf;
                    currentBalance += addedMoney;
                    localStorage.setItem('balance', currentBalance);
                    updateDisplay();
                    
                    tg.showAlert(`✅ SIKERES BEFIZETÉS!\n+${addedMoney} Ft jóváírva.`);
                    document.getElementById('txid-input').value = ""; 
                } else {
                    tg.showAlert("❌ Hiba: " + data.error);
                }

            } catch (e) {
                tg.MainButton.hide();
                tg.showAlert("Hálózati hiba! Próbáld újra.");
            }
        }
    </script>
</body>
</html>